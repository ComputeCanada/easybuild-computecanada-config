#!/bin/sh
module --force purge
module load nixpkgs/16.09
module use /cvmfs/soft.computecanada.ca/easybuild/modules/2017
NIX_PROF=/cvmfs/soft.computecanada.ca/nix/var/nix/profiles/16.09
if [ "$RSNT_ARCH" == avx2 ]; then
	export EASYBUILD_OPTARCH='PGI:tp=haswell;Intel:xCore-AVX2;GCC:march=core-avx2;GCCcore:GENERIC'
elif [ "$RSNT_ARCH" == avx512 ]; then
	export EASYBUILD_REPOSITORY='FileRepository'
	export EASYBUILD_REPOSITORYPATH=/cvmfs/soft.computecanada.ca/easybuild/ebfiles_repo_$RSNT_ARCH
	export EASYBUILD_ROBOT_PATHS=/cvmfs/soft.computecanada.ca/easybuild/easyconfigs:/cvmfs/soft.computecanada.ca/easybuild/ebfiles_repo_$RSNT_ARCH:/cvmfs/soft.computecanada.ca/easybuild/ebfiles_repo
	export EASYBUILD_OPTARCH='PGI:tp=skylake;Intel:xCore-AVX512;GCC:march=skylake-avx512;GCCcore:GENERIC'
	export EASYBUILD_USE_CCACHE=''
elif [ "$RSNT_ARCH" == avx ]; then
        export EASYBUILD_REPOSITORY='FileRepository'
        export EASYBUILD_REPOSITORYPATH=/cvmfs/soft.computecanada.ca/easybuild/ebfiles_repo_$RSNT_ARCH
	export EASYBUILD_ROBOT_PATHS=/cvmfs/soft.computecanada.ca/easybuild/easyconfigs:/cvmfs/soft.computecanada.ca/easybuild/ebfiles_repo_$RSNT_ARCH:/cvmfs/soft.computecanada.ca/easybuild/ebfiles_repo
	export EASYBUILD_OPTARCH='PGI:tp=sandybridge;Intel:xAVX;GCC:march=corei7-avx;GCCcore:GENERIC'
	export EASYBUILD_USE_CCACHE=''
elif [ "$RSNT_ARCH" == sse3 ]; then
        export EASYBUILD_REPOSITORY='FileRepository'
        export EASYBUILD_REPOSITORYPATH=/cvmfs/soft.computecanada.ca/easybuild/ebfiles_repo_$RSNT_ARCH
	export EASYBUILD_ROBOT_PATHS=/cvmfs/soft.computecanada.ca/easybuild/easyconfigs:/cvmfs/soft.computecanada.ca/easybuild/ebfiles_repo_$RSNT_ARCH:/cvmfs/soft.computecanada.ca/easybuild/ebfiles_repo
	export EASYBUILD_OPTARCH='PGI:tp=px;Intel:msse3;GCC:march=nocona -mtune=generic;GCCcore:GENERIC'
	export EASYBUILD_USE_CCACHE=''
else
	echo please set RSNT_ARCH to sse3, avx, or avx2
	exit
fi
if [ "$(whoami)" != "ebuser" ] ; then
	export EASYBUILD_PREFIX=$HOME/.local/easybuild
	export EASYBUILD_SUBDIR_USER_MODULES=''
        export EASYBUILD_REPOSITORY='FileRepository'
	export EASYBUILD_REPOSITORYPATH=$EASYBUILD_PREFIX/ebfiles_repo
	export EASYBUILD_ROBOT_PATHS=/cvmfs/soft.computecanada.ca/easybuild/easyconfigs:$EASYBUILD_REPOSITORYPATH:/cvmfs/soft.computecanada.ca/easybuild/ebfiles_repo
elif [ "$(id -ng)" != "ebuser" ] ; then
	# using ebuser with different group ID
	export EASYBUILD_INSTALLPATH_SOFTWARE=/cvmfs/restricted.computecanada.ca/easybuild/software/2017
	export EASYBUILD_SOURCEPATH=/cvmfs/restricted.computecanada.ca/easybuild/sources
fi
export EASYBUILD_HOOKS=/cvmfs/soft.computecanada.ca/easybuild/cc_hooks.py
export EASYBUILD_BUILDPATH=$EASYBUILD_BUILDPATH/$RSNT_ARCH
export LANG=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export PATH=$NIX_PROF/bin:$NIX_PROF/sbin:/cvmfs/soft.computecanada.ca/custom/bin:/cvmfs/soft.computecanada.ca/easybuild/bin
if [ ! -d /cvmfs/local ]; then
	export EASYBUILD_USE_CCACHE=''
fi
unset CPATH
export LIBRARY_PATH=$NIX_PROF/lib
export PKG_CONFIG_PATH=$NIX_PROF/lib/pkgconfig
export PYTHONPATH=/cvmfs/soft.computecanada.ca/easybuild/lib/python2.7/site-packages
export RSNT_EASYBUILD_MAGIC_COOKIE=263ca73bb634185aab1d1b41627fdbba
/cvmfs/soft.computecanada.ca/easybuild/framework/eb ${1+"$@"}
